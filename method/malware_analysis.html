<html>
    <meta name=”robots” content=”noindex,nofollow”/>
  <a href=../index.html>Back to home</a>
<hr/>
<h1>Malware Analysis</h1>
<h2>Sheep Dip Computer</h2>
<p>Sheep dipping is a process used in sheep farming, whereby sheep are dipped in chemical solutions to make them parasite-free. Sheep dipping refers to the analysis of suspicious files, 
incoming messages etc. for malware. The sheep dipped computer is isolated from the other computers on the network. Before performing this, it is important to save all downloaded programs on external media 
such as DVDs or CD-ROMs.</p>
<p>Malware analysis is a process of reverse engineering a specific piece of malware to determine its origin, functionality and potential impact. By performing malware analysis, one can extract detailed information
about the malware. Malware analysis is an integral part of any penetration testing process.</p>
<h2>Why Malware Analysis</h2>
<p><ol>
    <ul>Determine what exactly happened</ul>
    <ul>Determine the malicious intent of the malware</ul>
    <ul>Identify indicators of compromise</ul>
    <ul>Determine the complexity level of an intruder</ul>
    <ul>Identify the exploited vulnerability</ul>
    <ul>Identify the extent of damage caused by the intrusion</ul>
    <ul>Catch the perpetrator responsible for installing the malware</ul>
    <ul>Find signatures for host and network-based intrusion detection systems</ul>
    <ul>Evaluate the harm from an intrusion</ul>
    <ul>List the indicators of compromise for different machines and different malware programs</ul>
    <ul>Find the system vulnerability that the malware has exploited</ul>
    <ul>Distinguish the gatecrasher or insider responsible for the malware entry</ul>
    <ul>What is the intention of the malware</ul>
    <ul>How did it get through </ul>
    <ul>What is the impact on the business</ul>
    <ul>Who are the perpetrators and how good are they</ul>
    <ul>How to abolish the malware</ul>
    <ul>What are the losses</ul>
    <ul>How long has the system been infected</ul>
    <ul>What is the medium of the malware</ul>
    <ul>What are the preventive measures</ul>
</ol></p>
    <h2>Guidelines for malware analysis</h2>
    <p><ol>
        <ul>During malware analysis, pay attention to the essential features instead of understanding every detail</ul>
        <ul>Try different tools and approaches to analyze the malware, as a single approach may not be useful</ul>
        <ul>Identify, understand and defeat new malware analysis prevention techniques</ul>
    </ol></p>

    <h1>Type of malware analysis</h1>
    <h2>Static Malware Analysis</h2>
    <p>also known as code analysis, involves going through the executable binary code without executing it to gain a better understanding of the malware and its purpose. Pointers include filename, MD5 checksums / hash, file type and file size.</p>
    <h2>Dynamic Malware Analysis</h2>
    <p>also known as behavioral analyses, involving executing the malware code to known how it interacts with the host system. It reveals information such as domain names, file path locations, created registry keys, 
    IP addresses, additional files, installation files, DLL and linked files located on the system or network.</p>

    <h1>Malware Analysis Procedure</h1>
    <p>It is extremely dangerous to analyze malware on production devices connected to production networks. Analysis of malware must be done in a testing environment on an isolated network.</p>
    <p><ol>
        <ul>Preparing Testbed</ul>
        <ul>Static Analysis</ul>
        <ul>Dynamic Analysis</ul>
    </ol></p>

    <h1>Preparing Testbed</h1>
    <p><ol>
        <ul>An isolated test network to host the testbed and isolated network services such as DNS</ul>
        <ul>Target machines installed with a variety of OS and configuration states (non-patched, patched etc.)</ul>
        <ul>Virtualization snapshots and re-imaging tools to wipe and rebuild the target machine quickly</ul>
        <ul>Some tools are required for testing:</ul>
        <li>Imaging tool</li>
        <li>File / data analysis</li>
        <li>Registry / configuration tools</li>
        <li>Sandbox</li>
        <li>Log analyzers</li>
        <li>Network capture</li>
    </ol></p>

    <p>Steps to prepare the testbed:</p>
    <p><ol>
        <ul>Step 1: Allocate a physical system for the analysis lab</ul>
        <ul>Step 2: Install a virtual machine (VMWare, Hyper-V etc.) on the system</ul>
        <ul>Step 3: Install Guest OS on the virtual machine(s)</ul>
        <ul>Step 4: Isolate the system from the network by ensuring that the NIC card is in "host only" mode</ul>
        <ul>Step 5: Simulate Internet services using tools as <a target=_blank href=https://www.inetsim.org>INetSim</a></ul>
        <ul>Step 6: Disable "shared folders" and "guest isolation"</ul>
        <ul>Step 7: Install malware analysis tools</ul>
        <ul>Step 8: Generate the hash value of each OS and tool</ul>
        <ul>Step 9: Copy the malware to the guest OS</ul>
    </ol></p>
    <h2>Supporting Tools for malware analysis</h2>
    <p><ol>
        <ul>Virtual Machine Tools (Hyper-V, Parallels Desktop, Boot Camp, VMware Workstation Pro)</ul>
        <ul>Screen Capture and Recording tools (Snagit, FSCapture, Jing, Camtasia, Ezvid)</ul>
        <ul>Network and Internet simulation tools (Netsim Pro, ns-3, Riverbed Modeler, QualNet)</ul>
        <ul>OS Backup and Imaging Tools (Genie Backup Manager Pro, FTK Imager, Macrium Reflect Server, R-Drive Image, O&O DiskImage 17)</ul>
    </ol></p>

    <h1>Static Malware Analysis</h1>
    <p>Static analysis is safe to conduct because the investigator does not install or execute the suspicious file. Static analysis should be performed in a controlled environment.</p>
    <p><ol>
        <ul>File fingerprinting</ul>
        <ul>Local and online malware scanning</ul>
        <ul>Performing strings search</ul>
        <ul>Identifying packing / obfuscation methods</ul>
        <ul>Finding the portable executables (PE) information</ul>
        <ul>Identifying file dependencies</ul>
        <ul>Malware disassembly</ul>
        <ul>Analyzing ELF Executable files</ul>
        <ul>Analyzing Mach-O executable files</ul>
        <ul>Analyzing malicious MS Office documents</ul>
    </ol></p>

    <h2>File Fingerprinting</h2>
    <p>Computing the hash value for a given binary code to identify and track data across a network. Message-Digest Algorithm 5 (md5) and Secure Hash Algorithm 1 (sha-1) are the most commonly 
    used hash functions for malware analysis. Various tools such as <a target=_blank href=https://www.nirsoft.net/utils/hash_my_files.html>HashMyFiles</a> can be used to create a fingerprint of the 
    suspicious file as part of the static analysis. HashMyFiles also provides information about the file, such as the full path, date of creation, modification, file size, attributes, version, extension etc. </p>
    <p>Other fingerprinting tools:</p>
    <p><ol>
        <ul><a target=_blank href=https://github.com/ParrotSec/mimikatz>Mimikatz</a></ul>
        <ul><a target=_blank href=https://hashcalc.softonic.nl/>HashCalc</a></ul>
        <ul><a target=_blank href=https://www.kali.org/tools/hashdeep/>hashdeep</a></ul>
        <ul><a target=_blank href=https://www.pc-tools.net/win32/md5sums/>MD5sums</a></ul>
        <ul><a target=_blank href=https://www.tools4noobs.com/online_tools/hash/>tools4noobs</a></ul>
        <ul><a target=_blank href=https://www.exterro.com/ftk-product-downloads/ftk-imager-version-4-7-1>FTK Imager</a></ul>
        <ul><a target=_blank href=https://www.microsoft.com/en-us/download/details.aspx?id=24659>Microsoft Log Parser</a></ul>
    </ol></p>

    <h2>Local and Online Malware Scanning</h2>
    <p>You can scan the binary code locally using a well-known and up-to-date antivirus software. You can also upload the code to websites such as VirusTotal to get it scanned by a wide variety of scan engines.</p>
    <p><a target=_blank href=https://www.virustotal.com/gui/home/upload>VirusTotal</a> calculates the hash values of a suspicious file and compares them with online and offline malware databases to determine 
    the existence of the recognized malicious code. This process simplifies further investigation by offering deeper insights into the code, it's functionality and other essential details. <b>VirusTotal</b> is a free
    service that analyzes suspicious files and URLs. In addition, it facilitates the detection of viruses, worms, Trojans etc. It generates a report that provides the total number of engines that marked the file 
    as malicious, the malware name and, if available, additional information about the malware. It also offers important details of the online file analysis, such as target machine, compilation timestamp, type of file, 
    compatible processors, entry point, PE section, data link libraries (DLLs), used PE resources, different hash values, IP addresses accessed or contained in the file, program code, and type of connections 
    established. Some additional local and online malware scanning tools:</p>
    <p><ol>
        <ul><a target=_blank href=https://hybrid-analysis.com/>Hybrid Analysis</a></ul>
        <ul><a target=_blank href=https://cuckoo.cert.ee/>Cuckoo Sandbox</a></ul>
        <ul><a target=_blank href=https://virusscan.jotti.org/nl>Jotti</a></ul>
        <ul><a target=_blank href=https://valkyrie.comodo.com/>Valkyrie Sandbox</a></ul>
        <ul><a target=_blank href=https://www.fortiguard.com/faq/onlinescanner>FortiGuard Online Scanner</a></ul>
    </ol></p>
    
    <h2>Performing Strings Search</h2>
    <p>Software programs include some strings that are commands for performing specific functions. Strings communicate information from the program to its user. Various existing strings can represent the 
    malicious intent of a program, such as reading internal memory or cookie data.</p>
    <p>Use tools such as <a target=_blank href=https://www.aldeid.com/wiki/BinText>BinText</a> to extract embedded strings from executable files. Ensure that the tool can scan and display ASCII and Unicode strings.</p>
    <p><ol>
        <ul><a target=_blank href=https://www.aldeid.com/wiki/BinText>BinText</a></ul>
        <ul><a target=_blank href=https://go.exterro.com/l/43312/2023-05-03/fc4b78>FTK Imager</a></ul>
        <ul><a target=_blank href=https://www.fireeye.com>FLOSS</a></ul>
        <ul><a target=_blank href=https://learn.microsoft.com/nl-nl/sysinternals/downloads/strings>Strings</ul>
        <ul><a target=_blank href=https://www.resourceextract.com>Free EXE DLL Resource Extract</a></ul>
        <ul><a target=_blank href=https://www.fileseek.ca>FileSeek</a></ul>
        <ul><a target=_blank href=http://www.hexworkshop.com>Hex Workshop</a></ul>
    </ol></p>

    <h2>Identifying Packing / Obfuscation Methods</h2>
    <p>You should try to determine if the file includes packed elements and also locate the tool or method used for packing it. Use tools as <a target=_blank href=https://www.aldeid.com/wiki/PEiD>PEid</a>, which detects most commonly used packers, crypters and compilers for 
    PE executable files. Finding the packer will ease the task of selecting a tool for unpacking the code.</p>

    <h2>Identifying Packing / Obfuscation Method of Executable and Linkable Format (ELF) Malware</h2>
    <p><a target=_blank href=https://github.com/horsicq/Detect-It-Easy>Detect It Easy (DIE) is an application for determining types of files. It detect a file's compiler, linker, packer etc. using a signature-based 
    detection method.</p>
    <p>Additional packaging / obfuscation tools:</p>
    <p><ol>
        <ul><a target=_blank href=https://github.com/sevagas/macro_pack>Macro_Pack</a></ul>
        <ul><a target=_blank href=https://upx.github.io/>UPX</a></ul>
        <ul><a target=_blank href=http://aspack.com/>ASPack</a></ul>
        <ul>VMProtect</ul>
        <ul><a target=_blank href=https://github.com/ps2dev/ps2-packer>ps2-packer</a></ul>
    </ol></p>

    <h2>Finding the Portable Executables (PE) Information (Windows)</h2>
    <p>PE [<a target=_blank href=https://en.wikipedia.org/wiki/Windows_Preinstallation_Environment>wikipedia</a>] is an executable file format used on <b>Windows OS</b>. It stores metadata about the program, which helps in finding additional details of the file. The Windows binary is in PE format, and it
    consists of information such as time of creation and modification, import and export functions, compilation time, DLLs, linked files, strings, menus and symbols. The PE format contains a header and 
    sections that store metadata about the file and code mapping in an OS.
    </p>
    <p>Sections:</p>
    <p><ol>
        <ul>.text (instructions and program code that the CPU executes)</ul>
        <ul>.rdata (import and export information as well as other read-only data used by the program</ul>
        <ul>.data (global data, which the system can access from anywhere)</ul>
        <ul>.rsrc (resources employed by the executable, such as icons, images, menus, strings, multi-lingual support)</ul>
    </ol></p>
    <p>Tools</p>
    <p><ol>
        <ul><a target=_blank href=https://www.heaventools.com/overview.htm>PE Explorer</a></ul>
        <ul><a target=_blank href=https://tzworks.com/prototype_page.php?proto_id=15>Portable Executable Scanner (pescan)</a></ul>
        <ul><a target=_blank href=https://angusj.com/resourcehacker/>Resource Hacker</a></ul>
        <ul><a target=_blank href=https://www.aldeid.com/wiki/PEView>PEView</a></ul>
    </ol></p>

    <h2>Identifying File Dependencies</h2>
    <p>Any software program depends on various inbuilt libraries of an OS that help in performing specified actions in a system. Import and export functions are stored in a kernel32.dll file. </p>
    <p>Tools</p>
    <p><ol>
        <ul><a target=_blank href=https://www.dependencywalker.com/>Dependency Walker</a></ul>
        <ul><a target=_blank href=https://github.com/jeremylong/DependencyCheck>Dependency-check</a></ul>
        <ul><a target=_blank href=https://snyk.io>Snyk</a></ul>
        <ul><a target=_blank href=http://www.pe-explorer.com>PE Explorer Dependency Scanner</a></ul>
        <ul><a target=_blank href=https://retirejs.github.io>Retire.js</a></ul>
    </ol></p>

    <h2>Malware Disassembly</h2>
    <p>Dismantle a given executable into binary format to study its functionalities and features. This process helps to identify the language used for programming the malware, APIs that reveal its function etc. 
    Based on the reconstructed assembly code, you can inspect the program logic and recognize its threat potential. This process can be performed with:</p>
    <p><ol>
        <ul><a target=_blank href=https://hex-rays.com/ida-pro/>IDA Pro</a> -> multi-platform disassembler and debugger which makes it easy to find harmful or malicious processes</ul>
        <ul><a target=_blank href=https://hex-rays.com/ida-free/>IDA Free</a></ul>
        <ul><a target=_blank href=https://ghidra-sre.org>Ghirda</a></ul>
        <ul><a target=_blank href=https://x64dbg.com>x64dbg</a></ul>
        <ul><a target=_blank href=https://rada.re>Radare</a></ul>
        <ul><a target=_blank href=https://www.ollydbg.de>OllyDbg</a></ul>
        <ul><a target=_blank href=http://www.windbg.org>WinDbg</a></ul>
    </ol></p>
    <h2>Analyzing ELF Executable Files (Linux)</h2>
    <p>ELF [<a target=_blank href=https://nl.wikipedia.org/wiki/Executable_and_Linking_Format>wikipedia</a>] is a generic executable file format in <b>Linux</b>.</p>
