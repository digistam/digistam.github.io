<meta name=”robots” content=”noindex,nofollow”/>
  <a href=../index.html>Back to home</a>
<hr/>
<h1>Malware Analysis</h1>
<p>Malware analysis is a process of reverse engineering a specific piece of malware to determine its origin, functionality and potential impact. Malware analysis is an integral part of any penetration testing 
  process.</p>
<h2>Objectives</h2>
<p><ol>
  <ul>Determine what happened exactly</ul>
  <ul>Determine malicious intent of the malware</ul>
  <ul>Identify indicators of compromise</ul>
  <ul>Determine complexity level of an intruder</ul>
  <ul>Identify exploited vulnerability</ul>
  <ul>Identify extent of damage caused by the intrusion</ul>
  <ul>Catch the purpetrator responsible for installing the malware</ul>
  <ul>Find signatures for host and network-based intrusion detection systems</ul>
  <ul>Evaluate the harm from an intrusion</ul>
  <ul>List the indicators of compromise for different machines and different malware programs</ul>
  <ul>Find the system vulnerability that the malware has exploited</ul>
  <ul>Distinguish the gatecrasher or insider responsible for the malware entry</ul>
  <ul>Understand malware functionality</ul>
  <ul>Identify malware origin</ul>
</ol></p>
<p>The most common business questions answered by malware analysis are:</p>
<p><ol>
  <ul>What is the intention of the malware</ul>
  <ul>How did it get through</ul>
  <ul>What is the impact on the business</ul>
  <ul>Who are the purpetrators and how good are they</ul>
  <ul>How to abolish the malware</ul>
  <ul>What are the losses</ul>
  <ul>Which systems or data are at risk or have been compromised</ul>
  <ul>How long has the system been infected</ul>
  <ul>What is the medium of the malware</ul>
  <ul>What are the preventive measures</ul>
  <ul>What are the financial implications of the attack</ul>
  <ul>What legal actions can be taken</ul>
</ol>
<h2>Types of malware analysis</h2>
<p><ol>
  <ul>Static Malware Analysis -> code analysis, pointers include filename, MD5 checksums / hashes, file type, file size</ul>
  <ul>Dynamic Malware Analysis -> behavioral analysis, executing the malware code, reveals information such as domain names, file path locations, created registry keys, IP addresses, 
  additional files, installation files, DLL, linked files located on system or network</ul>
</ol></p>
<p>It is recommended that both static and dynamic analyses be performed to gain a deeper understanding of the functionality of malware.</p>

<h1>Malware Analysis Procedure</h1>
<p><ol>
  <ul>Preparing Testbed</ul>
  <ul>Static Analysis</ul>
  <ul>Dynamic Analysis</ul>
</ol></p>
<h2>Preparing Testbed</h2>
<p>Requirements:</p>
<p><ol>
  <ul>An isolated test network to host testbed and isolated network services such as DNS</ul>
  <ul>Target machines installed with a variety of OS and configuration states (non-patched, patched etc.)</ul>
  <ul>Virtualization snapshots and re-imaging tools to wipe and rebuild the target machine quickly</ul>
</ol></p>
<p>Tools:</p>
<p><ol>
  <ul>Imaging tools</ul>
  <ul>File / data analysis tools</ul>
  <ul>Registry / configuration tools</ul>
  <ul>Sandbox</ul>
  <ul>Log analyzers</ul>
  <ul>Network capture</ul>
</ol></p>
<p>Prepare testbed:</p>
<p><ol>
  <ul>Step 1: allocate a physical system for the analysis lab</ul>
  <ul>Step 2: install a virtual machine on the system</ul>
  <ul>Step 3: install guest OS on the virtual machine(s)</ul>
  <ul>Step 4: isolate the system from the network by ensuring the NIC card is in the <b>"host only"</b> mode </ul>
  <ul>Step 5: Simulate Internet services using tools such as <a target=_blank href=https://www.inetsim.org/>INetSim</a></ul>
  <ul>Step 6: Disable "shared folders" and "guest isolation"</ul>
  <ul>Step 7: Install malware analysis tools</ul>
  <ul>Step 8: generate the hash value of each OS and tool</ul>
  <ul>Step 9: copy the malware to the guest OS</ul>
</ol></p>
<h1>Tools</h1>
<h2>Virtual Machine Tools</h2>
<p><ol>
  <ul>VirtualBox</ul>
  <ul>VMware Workstation Pro</ul>
  <ul>Microsoft Hyper-V</ul>
  <ul>Parallels Desktop Pro</ul>
  <ul>Boot Camp</ul>
</ol></p>
<h2>Screen Capture and Recording</h2>
<p><ol>
  <ul>Snagit</ul>
  <ul>Techsmith Capture</ul>
  <ul>Camtasia</ul>
  <ul>Ezvid</ul>
</ol></p>
<h2>Network and Internet simulation tools</h2>
<p><ol>
  <ul>NetSim Professional</ul>
  <ul>ns-3</ul>
  <ul>Riverbed Modeler</ul>
  <ul>GNS3</ul>
</ol></p>
<h2>OS Backup and Imaging Tools</h2>
<p><ol>
  <ul>Genie Backup Manager Pro</ul>
  <ul>Macrium Reflect Server</ul>
  <ul>R-Drive Image</ul>
  <ul>O&O DiskImage 18 Server</ul>
</ol></p>
<h1>Static Malware Analysis</h1>
<p><ol>
  <ul>File fingerprinting</ul>
  <ul>Local and online malware scanning</ul>
  <ul>Performing strings search</ul>
  <ul>Identify packing/obfuscation methods</ul>
  <ul>Finding the portable executables (PE) information</ul>
  <ul>Identify file dependencies</ul>
  <ul>Malware disassembly</ul>
  <ul>Analyze ELF executable files</ul>
  <ul>Analyze Mach-O executable files</ul>
  <ul>Analyzing malicious MS Office documents</ul>
  <ul>Analysing suspicious PDF documents</ul>
</ol></p>
<h2>File fingerprinting</h2>
<p>Compute the hash value for a given binary to identify and track data across a network. The hash value can be used to uniquely identify the malware or periodically verify if any changes are made to the 
binary code during analysis. Fingerprinting does not work for certain record types, incl. encrypted or password-protected files, images, audio and video, which have different content compared to the predefined 
fingerprint. Most commonly used hash functions for malware analysis are MD5, SHA1 and SHA256.</p>
<h2>Local and Online malware scanning</h2>
<p>You can scan the binary code locally using well-known and up-to-date antivirus software. You can upload the code to websites such as VirusTotal to get it scanned by a wide variety of scan engines.</p>
<h2>Performing Strings search</h2>
<p>Use tools such as BinText to extract embedded strings from executable files. Ensure that the tool can scan and display ASCII and Unicode strings as well. </p>
<h2>Identify Packing/Obfuscation methods</h2>
<p>Use tools such as PEid, which detects most commonly used packers, crypters and compilers for PE executable files. <a target=_blank href=https://www.aldeid.com>PEid</a> is a free tool that privides 
details about Windows executable files. It can identify signatures associated with over 600 different packers and compilers.</p>
<p>Detect It Easy (DIE) is an application used for determining types of files. It detects a file's compiler, linker, packer etc. using a signature-based detection method.</p>
<h2>Finding Portable Executables (PE) Information</h2>
<p>PE format is an executable file format used on Windows OS, which stores the information that a Windows system requires to manage the executable code. It stores metadata about the program, which helps 
in finding additional details of the file. For instance, the Windows binary is in PE format, and it consists of information such as time of creation and modification, import and export functions, compilation 
time, DLLs, linked files, strings, menus and symbols. The PE format contains a header and sections that store metadata about the file and code mapping in an OS. The PE of a file contains:</p>
<p><ol>
  <ul>.text -> instructions and program code that the CPU executes</ul>
  <ul>.rdata -> import and export information as well as other read-only data used by the program</ul>
  <ul>.data -> the program's global data, which the system can access from anywhere</ul>
  <ul>.rsrc -> resource employed by the executable, such as icons, images, menus, strings and multi-lingual support</ul>
</ol></p>
<p>You can use tools such as <b>PE Explorer</b> to extract the information. Other tools: Portable Executable Scanner (pescan) and Resource Hacker.</p>
